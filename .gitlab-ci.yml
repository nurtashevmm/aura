variables:
  CARGO_HOME: "${CI_PROJECT_DIR}/.cargo"
  RUSTUP_HOME: "${CI_PROJECT_DIR}/.rustup"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo
    - .rustup
    - .wine/

stages:
  - setup
  - build

install_dependencies:
  stage: setup
  script:
    - echo "Установка базовых зависимостей..."
    - apt-get update -qq
    - apt-get install -y wget software-properties-common
    - wget -O- https://dl.winehq.org/wine-builds/winehq.key | apt-key add -
    - apt-add-repository "deb https://dl.winehq.org/wine-builds/ubuntu/ $(lsb_release -cs) main"
    - echo "Установка Wine (это может занять несколько минут)..."
    - apt-get install -y --install-recommends winehq-stable
    - wine --version
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
    - source "${CARGO_HOME}/env"
    - rustup target add x86_64-pc-windows-msvc
  timeout: 30 minutes
  artifacts:
    paths:
      - .wine/
    expire_in: 1 week

build_installer:
  stage: build
  script:
    - source "${CARGO_HOME}/env"
    - cargo build --release --target x86_64-pc-windows-msvc
    - mkdir -p target/release
    - cp target/x86_64-pc-windows-msvc/release/*.exe target/release/
    - cd installer
    - iscc AuraSetup.iss
  artifacts:
    paths:
      - installer/Output/AuraSetup.exe
    expire_in: 1 week
